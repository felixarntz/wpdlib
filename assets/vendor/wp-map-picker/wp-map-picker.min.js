/*!
 * WP Map Picker -  version 0.1.0
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b){function c(a,b){this.$elem=a,this.settings=b}if("undefined"==typeof a.fn.wpMapPicker){if("undefined"==typeof b||"undefined"==typeof b.maps)return a.fn.wpMapPicker=function(){return this},void console.error("Google Maps not found");c.prototype={init:function(){this.canvas=this.$elem.next().find(".wp-mappicker-map-canvas")[0],this.geocoder=new b.maps.Geocoder;var a=this;this.initLatLng(function(b,c){a.initMap(b,c),a.initEvents()})},initLatLng:function(a){var c,d=!1;"coords"===this.settings.store?(c=this.parseLatLng(this.$elem.val()),c||(c=new b.maps.LatLng(this.settings.default_location.lat,this.settings.default_location.lng),d=!0),a(c,d)):this.$elem.val()?this.geocoder.geocode({address:this.$elem.val()},function(e){"undefined"!=typeof e[0]&&"undefined"!=typeof e[0].geometry&&"undefined"!=typeof e[0].geometry.location?a(e[0].geometry.location,!1):(c=new b.maps.LatLng(this.settings.default_location.lat,this.settings.default_location.lng),d=!0,a(c,d))}):(c=new b.maps.LatLng(this.settings.default_location.lat,this.settings.default_location.lng),d=!0,a(c,d))},initMap:function(a,c){this.is_default=c,this.latlng=a,this.map=new b.maps.Map(this.canvas,{center:this.latlng,zoom:this.is_default?this.settings.default_location.zoom:this.settings.zoom,draggable:this.settings.draggable,tilt:0,streetViewControl:0,mapTypeId:b.maps.MapTypeId[this.settings.mapType.toUpperCase()]}),this.marker=new b.maps.Marker({position:this.latlng,map:this.map,draggable:!0})},initEvents:function(){var c=this;"coords"===this.settings.store?this.$elem.on("change",function(){var b=c.parseLatLng(a(this).val());b&&(c.latlng=b,c.marker.setPosition(c.latlng),c.map.setCenter(c.latlng),c.is_default&&(c.is_default=!1,c.map.setZoom(c.settings.zoom)))}):this.$elem.autocomplete({source:function(b,d){c.geocoder.geocode({address:b.term},function(b){d(a.map(b,function(a){return{label:a.formatted_address,value:a.formatted_address,latlng:a.geometry.location}}))})},select:function(a,b){c.latlng=b.item.latlng,c.marker.setPosition(c.latlng),c.map.setCenter(c.latlng),c.is_default&&(c.is_default=!1,c.map.setZoom(c.settings.zoom))}}),b.maps.event.addListener(this.map,"click",function(a){c.latlng=a.latLng,c.marker.setPosition(c.latlng),c.is_default&&(c.is_default=!1,c.map.setCenter(c.latlng),c.map.setZoom(c.settings.zoom)),c.updateFieldValue()}),b.maps.event.addListener(this.marker,"dragend",function(a){c.latlng=a.latLng,c.is_default&&(c.is_default=!1,c.map.setCenter(c.latlng),c.map.setZoom(c.settings.zoom)),c.updateFieldValue()})},updateFieldValue:function(){if("coords"===this.settings.store)this.$elem.val(this.formatLatLng(this.latlng));else{var a=this;this.geocoder.geocode({location:this.latlng},function(b){"undefined"!=typeof b[0]&&"undefined"!=typeof b[0].formatted_address&&a.$elem.val(b[0].formatted_address)})}},parseLatLng:function(a){if("object"==typeof a)return a;if(a=a.split("|"),2!==a.length)return!1;for(var c=0;2>c;c++)a[c]=parseFloat(a[c].replace(this.settings.decimal_separator,"."));return new b.maps.LatLng(a[0],a[1])},formatLatLng:function(a){return"string"==typeof a?a:(""+a.lat()).replace(".",this.settings.decimal_separator)+"|"+(""+a.lng()).replace(".",this.settings.decimal_separator)}};var d=function(a){var b=a.attr("id");a.after('<div class="wp-mappicker-map-canvas-wrap"><div data-input-id="'+b+'" class="wp-mappicker-map-canvas"></div></div>')};a.fn.wpMapPicker=function(b){return b=a.extend({store:"address",zoom:15,draggable:!0,mapType:"roadmap",default_location:{lat:"0.0",lng:"0.0",zoom:2},decimal_separator:"."},b||{}),this.each(function(){if(!a(this).data("wp-map-picker")){var e=a(this),f=a.extend({},b),g=e.data("settings");if(g){if("string"==typeof g)try{g=JSON.parse(g)}catch(h){console.error(h.message)}"object"==typeof g&&(f=a.extend(f,g))}d(e);var i=new c(e,f);i.init(),e.data("wp-map-picker",i)}})}}}(jQuery,google);